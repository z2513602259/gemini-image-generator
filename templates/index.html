<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini 图片生成器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card-shadow {
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        }
        .upload-zone {
            border: 2px dashed #cbd5e1;
            transition: all 0.3s ease;
        }
        .upload-zone:hover, .upload-zone.dragover {
            border-color: #667eea;
            background-color: #f0f4ff;
        }
        .preview-image {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 8px;
        }
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .result-image {
            max-width: 100%;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }
        
        /* 历史记录抽屉样式 */
        .history-drawer {
            width: 100%;
            max-width: 600px;
            transform: translateX(100%);
            transition: transform 0.3s ease-in-out;
        }
        
        /* 抽屉打开时的状态 */
        #historyModal:not(.hidden) .history-drawer {
            transform: translateX(0);
        }
        
        /* 响应式设计 */
        @media (max-width: 640px) {
            /* 小屏幕（手机） */
            .history-drawer {
                width: 100%;
                max-width: none;
            }
        }
        
        @media (min-width: 641px) and (max-width: 1024px) {
            /* 中等屏幕（平板） */
            .history-drawer {
                width: 70%;
                max-width: 600px;
            }
        }
        
        @media (min-width: 1025px) {
            /* 大屏幕（桌面） */
            .history-drawer {
                width: 50%;
                max-width: 600px;
            }
        }
        
        /* 抽屉内容区域滚动条样式 */
        .drawer-content::-webkit-scrollbar {
            width: 8px;
        }
        
        .drawer-content::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        .drawer-content::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }
        
        .drawer-content::-webkit-scrollbar-thumb:hover {
            background: #a1a1a1;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="gradient-bg text-white py-6">
        <div class="container mx-auto px-4">
            <div class="flex items-center justify-center gap-3 relative">
                <i class="fas fa-magic text-3xl"></i>
                <h1 class="text-3xl font-bold">Gemini 图片生成器</h1>
                <div class="absolute right-0 top-1/2 -translate-y-1/2 flex bg-purple-600 hover:bg-purple-700 rounded-lg transition">
                    <button onclick="openHistory()" class="px-4 py-2 flex items-center gap-2 transition hover:bg-purple-500 rounded-l-lg">
                        <i class="fas fa-clock-rotate-left"></i>
                        <span class="hidden sm:inline">历史</span>
                    </button>
                    <button onclick="openSettings()" class="px-4 py-2 flex items-center gap-2 transition hover:bg-purple-500 rounded-r-lg">
                        <i class="fas fa-cog"></i>
                        <span class="hidden sm:inline">设置</span>
                    </button>
                </div>
            </div>
            <p class="text-center mt-2 text-purple-100">使用 AI 将你的想法变成精美图片</p>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8 max-w-7xl">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 h-[calc(100vh-200px)]">
            <!-- 左侧：输入区域 -->
            <div class="bg-white rounded-2xl card-shadow p-6 overflow-y-auto">
                <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                    <i class="fas fa-edit text-purple-500"></i>
                    输入设置
                </h2>
                <form id="generateForm">
                    <!-- 提示词输入 -->
                    <div class="mb-5">
                        <label class="block text-gray-700 font-semibold mb-2">
                            <i class="fas fa-pen-fancy mr-2 text-purple-500"></i>提示词
                        </label>
                        <textarea 
                            id="prompt" 
                            name="prompt" 
                            rows="5" 
                            class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent transition resize-none"
                            placeholder="描述你想生成的图片，例如：生成一个极简风格的室内设计效果图..."
                        ></textarea>
                    </div>

                    <!-- 图片上传 -->
                    <div class="mb-5">
                        <label class="block text-gray-700 font-semibold mb-2">
                            <i class="fas fa-images mr-2 text-purple-500"></i>参考图片（可选）
                        </label>
                        <div 
                            id="uploadZone" 
                            class="upload-zone rounded-xl p-6 text-center cursor-pointer"
                            onclick="document.getElementById('imageInput').click()"
                        >
                            <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-2"></i>
                            <p class="text-gray-500 text-sm">点击或拖拽图片到此处上传</p>
                            <p class="text-gray-400 text-xs mt-1">支持 PNG, JPG, GIF, WebP</p>
                            <input 
                                type="file" 
                                id="imageInput" 
                                name="images" 
                                multiple 
                                accept="image/*" 
                                class="hidden"
                            >
                        </div>
                        <!-- 预览区域 -->
                        <div id="previewContainer" class="flex flex-wrap gap-3 mt-3"></div>
                    </div>

                    <!-- 配置选项 -->
                    <div class="grid grid-cols-2 gap-4 mb-5">
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2 text-sm">
                                <i class="fas fa-crop-alt mr-2 text-purple-500"></i>图片比例
                            </label>
                            <select 
                                id="aspectRatio" 
                                name="aspect_ratio"
                                class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent text-sm"
                            >
                                <option value="1:1">1:1 (正方形)</option>
                                <option value="16:9">16:9 (横向)</option>
                                <option value="9:16">9:16 (竖向)</option>
                                <option value="4:3">4:3 (标准)</option>
                                <option value="3:4">3:4 (肖像)</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2 text-sm">
                                <i class="fas fa-expand-arrows-alt mr-2 text-purple-500"></i>分辨率
                            </label>
                            <select 
                                id="imageSize" 
                                name="image_size"
                                class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent text-sm"
                            >
                                <option value="1K">1K</option>
                                <option value="2K" selected>2K</option>
                                <option value="4K">4K</option>
                            </select>
                        </div>
                    </div>

                    <!-- 生成按钮 -->
                    <button 
                        type="submit" 
                        id="generateBtn"
                        class="w-full gradient-bg text-white font-semibold py-3 rounded-xl hover:opacity-90 transition flex items-center justify-center gap-2"
                    >
                        <i class="fas fa-wand-magic-sparkles"></i>
                        <span>生成图片</span>
                    </button>
                </form>
            </div>

            <!-- 右侧：结果区域 -->
            <div class="bg-white rounded-2xl card-shadow p-6 overflow-y-auto">
                <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                    <i class="fas fa-image text-purple-500"></i>
                    生成结果
                </h2>

                <!-- 状态容器 -->
                <div id="stateContainer" class="h-[calc(100%-60px)]">
                    <!-- 默认状态 -->
                    <div id="emptyState" class="flex flex-col items-center justify-center h-full text-gray-400">
                        <i class="fas fa-images text-6xl mb-4"></i>
                        <p>生成的图片将显示在这里</p>
                    </div>

                    <!-- 加载状态 -->
                    <div id="loadingState" style="display: none;" class="flex flex-col items-center justify-center h-full">
                        <div class="loading-spinner mb-4"></div>
                        <p class="text-gray-600">正在生成中，请稍候...</p>
                        <p class="text-gray-400 text-sm mt-1">这可能需要 30 秒到 2 分钟</p>
                    </div>

                    <!-- 错误提示 -->
                    <div id="errorContainer" style="display: none;" class="flex flex-col items-center justify-center h-full">
                        <div class="bg-red-50 border border-red-200 rounded-xl p-6">
                            <div class="flex items-center gap-3 text-red-600">
                                <i class="fas fa-exclamation-circle text-xl"></i>
                                <span id="errorMessage"></span>
                            </div>
                        </div>
                    </div>

                    <!-- 结果展示 -->
                    <div id="resultContainer" style="display: none;" class="h-full overflow-y-auto">
                        <div id="results">
                            <!-- 结果将在这里动态插入 -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="text-center py-6 text-gray-500 text-sm">
        <p>Powered by Gemini AI</p>
    </footer>

    <!-- 图片预览模态框 -->
    <div id="imageModal" class="fixed inset-0 bg-black/90 z-90 hidden items-center justify-center p-4" onclick="closeModal(event)">
        <button onclick="event.stopPropagation(); closeModal();" class="absolute top-4 right-4 text-white hover:text-gray-300 transition z-10">
            <i class="fas fa-times text-3xl"></i>
        </button>
        <img id="modalImage" src="" class="max-w-full max-h-full object-contain cursor-default" onclick="event.stopPropagation()">
        <a id="modalDownload" href="" download class="absolute bottom-6 left-1/2 -translate-x-1/2 bg-white/20 hover:bg-white/30 text-white px-6 py-2 rounded-lg backdrop-blur transition flex items-center gap-2">
            <i class="fas fa-download"></i>
            下载原图
        </a>
    </div>

    <!-- 设置模态框 -->
    <div id="settingsModal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center p-4" onclick="closeSettings(event)">
        <div class="bg-white rounded-2xl w-full max-w-lg p-6" onclick="event.stopPropagation()">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                    <i class="fas fa-cog text-purple-500"></i>
                    API 设置
                </h3>
                <button onclick="closeSettings()" class="text-gray-400 hover:text-gray-600 transition">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <form id="settingsForm">
                <div class="mb-4">
                    <label class="block text-gray-700 font-semibold mb-2">
                        <i class="fas fa-key mr-2 text-purple-500"></i>API Key
                    </label>
                    <input 
                        type="password" 
                        id="settingsApiKey" 
                        class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                        placeholder="输入 API Key"
                    >
                    <p class="text-gray-400 text-sm mt-1">当前: <span id="currentApiKey">-</span></p>
                </div>
                <div class="mb-6">
                    <label class="block text-gray-700 font-semibold mb-2">
                        <i class="fas fa-link mr-2 text-purple-500"></i>API URL
                    </label>
                    <input 
                        type="text" 
                        id="settingsApiUrl" 
                        class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                        placeholder="输入 API URL"
                    >
                </div>
                <div class="flex gap-3">
                    <button 
                        type="button" 
                        onclick="closeSettings()" 
                        class="flex-1 bg-gray-100 text-gray-700 font-semibold py-3 rounded-xl hover:bg-gray-200 transition"
                    >
                        取消
                    </button>
                    <button 
                        type="submit" 
                        class="flex-1 gradient-bg text-white font-semibold py-3 rounded-xl hover:opacity-90 transition"
                    >
                        保存设置
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- 历史记录抽屉 -->
    <div id="historyModal" class="fixed inset-0 bg-black/50 z-50 hidden transition-opacity duration-300" onclick="closeHistory(event)">
        <div class="history-drawer fixed top-0 right-0 h-full bg-white shadow-2xl overflow-hidden flex flex-col z-50" onclick="event.stopPropagation()">
            <div class="drawer-header p-6 border-b border-gray-200 flex items-center justify-between">
                <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                    <i class="fas fa-clock-rotate-left text-purple-500"></i>
                    历史记录
                </h3>
                <div class="flex gap-3">
                    <button onclick="clearHistory()" class="bg-red-500 text-white px-3 py-1 rounded-lg hover:bg-red-600 transition text-sm">
                        <i class="fas fa-trash"></i>
                        清空历史
                    </button>
                    <button onclick="closeHistory()" class="text-gray-400 hover:text-gray-600 transition">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            <div class="drawer-content flex-1 overflow-y-auto p-6 space-y-4">
                <div id="historyList" class="space-y-4">
                    <!-- 历史记录将在这里动态插入 -->
                </div>
                <div id="emptyHistory" class="text-center py-12 text-gray-400" style="display: none;">
                    <i class="fas fa-clock text-6xl mb-4"></i>
                    <p>暂无历史记录</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 基础DOM元素
        const form = document.getElementById('generateForm');
        const imageInput = document.getElementById('imageInput');
        const uploadZone = document.getElementById('uploadZone');
        const previewContainer = document.getElementById('previewContainer');
        const loadingState = document.getElementById('loadingState');
        const resultContainer = document.getElementById('resultContainer');
        const results = document.getElementById('results');
        const errorContainer = document.getElementById('errorContainer');
        const errorMessage = document.getElementById('errorMessage');
        const generateBtn = document.getElementById('generateBtn');
        const emptyState = document.getElementById('emptyState');
        
        // 历史记录相关DOM元素
        const historyModal = document.getElementById('historyModal');
        const historyList = document.getElementById('historyList');
        const emptyHistory = document.getElementById('emptyHistory');
        
        // 生成开始时间
        let generateStartTime = 0;

        let selectedFiles = [];

        // 拖拽上传
        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadZone.classList.add('dragover');
        });

        uploadZone.addEventListener('dragleave', () => {
            uploadZone.classList.remove('dragover');
        });

        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            const files = Array.from(e.dataTransfer.files).filter(f => f.type.startsWith('image/'));
            addFiles(files);
        });

        // 文件选择
        imageInput.addEventListener('change', (e) => {
            addFiles(Array.from(e.target.files));
            // 重置 input 以允许重新选择相同文件
            e.target.value = '';
        });

        function addFiles(files) {
            selectedFiles = [...selectedFiles, ...files];
            renderPreviews();
        }

        function renderPreviews() {
            previewContainer.innerHTML = '';
            selectedFiles.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const div = document.createElement('div');
                    div.className = 'relative group flex flex-col items-center';
                    div.innerHTML = `
                        <img src="${e.target.result}" class="preview-image">
                        <div class="mt-1 text-xs text-gray-600 text-center w-full truncate px-1">
                            ${file.name}
                        </div>
                        <button 
                            type="button"
                            onclick="removeFile(${index})"
                            class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 transition"
                        >
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    previewContainer.appendChild(div);
                };
                reader.readAsDataURL(file);
            });
        }

        function removeFile(index) {
            selectedFiles.splice(index, 1);
            renderPreviews();
        }

        // 表单提交
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const prompt = document.getElementById('prompt').value.trim();
            if (!prompt) {
                showError('请输入提示词');
                return;
            }

            // 从 localStorage 加载 API 配置
            const config = loadLocalConfig();
            if (!config.apiKey) {
                showError('请先在设置中配置 API Key！点击右上角齿轮图标进行设置。');
                return;
            }

            // 记录生成开始时间
            generateStartTime = Date.now();

            // 显示加载状态
            emptyState.style.display = 'none';
            loadingState.style.display = 'flex';
            resultContainer.style.display = 'none';
            errorContainer.style.display = 'none';
            generateBtn.disabled = true;
            generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 生成中...';

            const formData = new FormData();
            formData.append('prompt', prompt);
            formData.append('aspect_ratio', document.getElementById('aspectRatio').value);
            formData.append('image_size', document.getElementById('imageSize').value);
            formData.append('api_key', config.apiKey);
            formData.append('api_url', config.apiUrl);
            
            selectedFiles.forEach(file => {
                formData.append('images', file);
            });

            try {
                const response = await fetch('/generate', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.error) {
                    showError(data.error);
                } else {
                    showResults(data.results);
                }
            } catch (error) {
                showError('请求失败: ' + error.message);
            } finally {
                loadingState.style.display = 'none';
                generateBtn.disabled = false;
                generateBtn.innerHTML = '<i class="fas fa-wand-magic-sparkles"></i> 生成图片';
            }
        });

        function showError(message) {
            emptyState.style.display = 'none';
            resultContainer.style.display = 'none';
            errorMessage.textContent = message;
            errorContainer.style.display = 'flex';
        }

        function showResults(data) {
            emptyState.style.display = 'none';
            errorContainer.style.display = 'none';
            results.innerHTML = '';
            data.forEach(item => {
                if (item.type === 'image') {
                    const div = document.createElement('div');
                    div.className = 'mb-4';
                    div.innerHTML = `
                        <img src="${item.url}" class="result-image mx-auto cursor-pointer hover:opacity-90 transition" onclick="openModal('${item.url}')" title="点击查看大图">
                        <div class="text-center mt-4">
                            <button onclick="openModal('${item.url}')" class="inline-flex items-center gap-2 bg-gray-100 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-200 transition mr-2">
                                <i class="fas fa-expand"></i>
                                查看大图
                            </button>
                            <a href="${item.url}" download class="inline-flex items-center gap-2 bg-purple-500 text-white px-4 py-2 rounded-lg hover:bg-purple-600 transition">
                                <i class="fas fa-download"></i>
                                下载图片
                            </a>
                        </div>
                    `;
                    results.appendChild(div);
                } else if (item.type === 'text') {
                    const div = document.createElement('div');
                    div.className = 'bg-gray-50 rounded-lg p-4 mb-4';
                    div.innerHTML = `<p class="text-gray-700">${item.content}</p>`;
                    results.appendChild(div);
                }
            });
            resultContainer.style.display = 'block';
            
            // 保存历史记录到本地
            const prompt = document.getElementById('prompt').value.trim();
            const aspectRatio = document.getElementById('aspectRatio').value;
            const imageSize = document.getElementById('imageSize').value;
            const images = data.filter(item => item.type === 'image').map(item => item.url);
            const texts = data.filter(item => item.type === 'text').map(item => item.content);
            const duration = (Date.now() - generateStartTime) / 1000;
            
            const historyItem = {
                id: Date.now().toString(), // 本地生成ID
                prompt: prompt,
                aspect_ratio: aspectRatio,
                image_size: imageSize,
                images: images,
                texts: texts,
                duration: duration,
                created_at: new Date().toISOString()
            };
            
            // 保存到本地存储
            saveHistoryToLocal(historyItem);
            
            // 如果历史记录抽屉已打开，自动更新
            if (!historyModal.classList.contains('hidden')) {
                renderHistory();
            }
        }

        // 图片预览模态框
        const imageModal = document.getElementById('imageModal');
        const modalImage = document.getElementById('modalImage');
        const modalDownload = document.getElementById('modalDownload');

        function openModal(imageUrl) {
            modalImage.src = imageUrl;
            modalDownload.href = imageUrl;
            
            // 关闭其他模态框
            if (!settingsModal.classList.contains('hidden')) {
                closeSettings();
            }
            if (!historyModal.classList.contains('hidden')) {
                closeHistory();
            }
            
            imageModal.classList.remove('hidden');
            imageModal.classList.add('flex');
            document.body.style.overflow = 'hidden';
        }

        function closeModal(event) {
            if (event && event.target && event.target !== imageModal) return;
            imageModal.classList.add('hidden');
            imageModal.classList.remove('flex');
            document.body.style.overflow = '';
        }

        // ESC 键关闭模态框
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                if (!imageModal.classList.contains('hidden')) {
                    closeModal();
                }
                if (!settingsModal.classList.contains('hidden')) {
                    closeSettings();
                }
                if (!historyModal.classList.contains('hidden')) {
                    closeHistory();
                }
            }
        });

        // 本地历史记录管理函数
        function saveHistoryToLocal(item) {
            try {
                const history = loadHistoryFromLocal();
                history.unshift(item);
                // 限制本地历史记录数量，最多保存50条
                if (history.length > 50) {
                    history.pop();
                }
                localStorage.setItem('gemini_history', JSON.stringify(history));
            } catch (error) {
                console.error('保存本地历史记录失败:', error);
            }
        }
        
        function loadHistoryFromLocal() {
            try {
                const history = localStorage.getItem('gemini_history');
                return history ? JSON.parse(history) : [];
            } catch (error) {
                console.error('加载本地历史记录失败:', error);
                return [];
            }
        }
        
        function clearHistoryFromLocal() {
            try {
                localStorage.removeItem('gemini_history');
            } catch (error) {
                console.error('清空本地历史记录失败:', error);
            }
        }
        
        // 加载历史记录
        async function loadHistory() {
            try {
                const response = await fetch('/history');
                const data = await response.json();
                if (data.success) {
                    return data.history;
                } else {
                    console.error('加载Supabase历史记录失败:', data.error);
                    // 如果Supabase失败，返回空数组，后续会从本地加载
                    return [];
                }
            } catch (error) {
                console.error('加载Supabase历史记录失败:', error);
                // 如果请求失败，返回空数组，后续会从本地加载
                return [];
            }
        }
        
        // 清空历史记录
        async function clearHistory() {
            if (confirm('确定要清空所有历史记录吗？')) {
                let hasError = false;
                
                // 尝试清空Supabase历史记录
                try {
                    const response = await fetch('/history', {
                        method: 'DELETE'
                    });
                    const data = await response.json();
                    if (!data.success) {
                        console.error('清空Supabase历史记录失败:', data.error);
                        // 不抛出错误，继续清空本地记录
                    }
                } catch (error) {
                    console.error('清空Supabase历史记录失败:', error);
                    // 不抛出错误，继续清空本地记录
                }
                
                // 清空本地历史记录
                clearHistoryFromLocal();
                
                // 重新渲染历史记录
                renderHistory();
            }
        }
        
        // 显示历史记录
        async function renderHistory() {
            // 先从Supabase加载历史记录
            let supabaseHistory = await loadHistory();
            
            // 再从本地加载历史记录
            const localHistory = loadHistoryFromLocal();
            
            // 合并历史记录，去重（优先保留Supabase的记录）
            const allHistory = [...supabaseHistory, ...localHistory];
            
            // 去重，根据id或创建时间
            const uniqueHistory = [];
            const seenIds = new Set();
            
            for (const item of allHistory) {
                const id = item.id || item.created_at;
                if (!seenIds.has(id)) {
                    seenIds.add(id);
                    uniqueHistory.push(item);
                }
            }
            
            // 按时间排序，最新的在前
            uniqueHistory.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            
            if (uniqueHistory.length === 0) {
                historyList.innerHTML = '';
                historyList.style.display = 'none';
                emptyHistory.style.display = 'block';
                return;
            }
            
            historyList.style.display = 'block';
            emptyHistory.style.display = 'none';
            
            historyList.innerHTML = uniqueHistory.map(item => `
                <div class="border border-gray-200 rounded-xl p-4">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-3 gap-2">
                        <div class="text-sm text-gray-500">
                            <i class="fas fa-clock"></i>
                            <span>${new Date(item.created_at).toLocaleString('zh-CN')}</span>
                            <span class="ml-2">
                                <i class="fas fa-stopwatch"></i>
                                <span>${item.duration.toFixed(1)}秒</span>
                            </span>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="copyPrompt('${encodeURIComponent(item.prompt)}')" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-1 rounded-lg text-sm transition">
                                <i class="fas fa-copy"></i>
                                复制提示词
                            </button>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <h4 class="font-semibold text-gray-800 mb-1">提示词:</h4>
                        <p class="text-sm text-gray-600 bg-gray-50 p-3 rounded-lg max-h-24 overflow-y-auto">${item.prompt}</p>
                    </div>
                    
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                        ${item.images.map(imgUrl => `
                            <div class="relative">
                                <img src="${imgUrl}" class="w-full h-32 object-cover rounded-lg cursor-pointer hover:opacity-90 transition" onclick="openModal('${imgUrl}')">
                                <a href="${imgUrl}" download class="absolute bottom-2 right-2 bg-purple-500 text-white px-2 py-1 rounded text-xs hover:bg-purple-600 transition">
                                    <i class="fas fa-download"></i>
                                </a>
                            </div>
                        `).join('')}
                    </div>
                    
                    ${item.texts.length > 0 ? `
                        <div class="mt-3">
                            <h4 class="font-semibold text-gray-800 mb-1">生成文本:</h4>
                            ${item.texts.map(text => `
                                <p class="text-sm text-gray-600 bg-gray-50 p-3 rounded-lg mb-2">${text}</p>
                            `).join('')}
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }
        
        // 复制提示词
        function copyPrompt(prompt) {
            const decodedPrompt = decodeURIComponent(prompt);
            navigator.clipboard.writeText(decodedPrompt).then(() => {
                // 显示复制成功提示
                const btn = event.target.closest('button');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check"></i> 已复制';
                btn.classList.remove('bg-gray-100', 'hover:bg-gray-200', 'text-gray-700');
                btn.classList.add('bg-green-100', 'text-green-700');
                
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.classList.remove('bg-green-100', 'text-green-700');
                    btn.classList.add('bg-gray-100', 'hover:bg-gray-200', 'text-gray-700');
                }, 1500);
            }).catch(err => {
                console.error('复制失败:', err);
                alert('复制失败，请手动复制');
            });
        }
        
        // 打开历史记录抽屉
        function openHistory() {
            // 关闭其他模态框
            if (!settingsModal.classList.contains('hidden')) {
                closeSettings();
            }
            if (!imageModal.classList.contains('hidden')) {
                closeModal();
            }
            
            // 加载历史记录并显示抽屉
            renderHistory();
            historyModal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }
        
        // 关闭历史记录抽屉
        function closeHistory(event) {
            // 只有点击模态框背景或关闭按钮时才关闭
            if (event && event.target && event.target !== historyModal && !event.target.closest('.fa-times')) return;
            
            historyModal.classList.add('hidden');
            document.body.style.overflow = '';
        }

        // 设置功能 - 使用 localStorage 保存配置
        const settingsModal = document.getElementById('settingsModal');
        const settingsForm = document.getElementById('settingsForm');
        const settingsApiKey = document.getElementById('settingsApiKey');
        const settingsApiUrl = document.getElementById('settingsApiUrl');
        const currentApiKey = document.getElementById('currentApiKey');

        // 从 localStorage 加载配置
        function loadLocalConfig() {
            const apiKey = localStorage.getItem('gemini_api_key') || '';
            const apiUrl = localStorage.getItem('gemini_api_url') || 'https://api.vectorengine.ai/v1beta/models/gemini-3-pro-image-preview:generateContent';
            return { apiKey, apiUrl };
        }

        // 保存配置到 localStorage
        function saveLocalConfig(apiKey, apiUrl) {
            if (apiKey) {
                localStorage.setItem('gemini_api_key', apiKey);
            }
            if (apiUrl) {
                localStorage.setItem('gemini_api_url', apiUrl);
            }
        }

        function maskApiKey(key) {
            if (!key || key.length < 8) return '未设置';
            return key.substring(0, 4) + '*'.repeat(key.length - 8) + key.substring(key.length - 4);
        }

        async function openSettings() {
            // 从本地加载设置
            const config = loadLocalConfig();
            settingsApiUrl.value = config.apiUrl;
            currentApiKey.textContent = maskApiKey(config.apiKey);
            settingsApiKey.value = '';
            settingsApiKey.placeholder = config.apiKey ? '留空则保持不变' : '请输入 API Key';
            
            settingsModal.classList.remove('hidden');
            settingsModal.classList.add('flex');
            document.body.style.overflow = 'hidden';
        }

        function closeSettings(event) {
            if (event && event.target && event.target !== settingsModal) return;
            settingsModal.classList.add('hidden');
            settingsModal.classList.remove('flex');
            document.body.style.overflow = '';
        }

        settingsForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const config = loadLocalConfig();
            
            // 更新配置
            if (settingsApiKey.value.trim()) {
                config.apiKey = settingsApiKey.value.trim();
            }
            if (settingsApiUrl.value.trim()) {
                config.apiUrl = settingsApiUrl.value.trim();
            }
            
            // 验证必填项
            if (!config.apiKey) {
                alert('请输入 API Key！');
                return;
            }
            
            // 保存到 localStorage
            saveLocalConfig(config.apiKey, config.apiUrl);
            
            alert('设置已保存！');
            closeSettings();
        });
    </script>
</body>
</html>
